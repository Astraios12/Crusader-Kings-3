# Slave Prostitution Doctrine: Changes line 99 from doctrine to parameter
# Slave Prostitutes: Changes line 50 & 82 and adds cse_is_working_as_slave_prostitute_trigger
# Slave Prostitutes: Adds if condition at line 170 to use cse payment calculation
# Courtesans: Adds if condition at line 107 to trigger date with courtesan

carn_sex_interaction = {
    category = interaction_category_friendly
    
    desc = carn_sex_interaction_desc
    interface_priority = 40
    use_diplomatic_range = no
	common_interaction = yes

    is_shown = {
        NOR = {
            has_game_rule = carn_sex_interaction_disabled
            scope:actor = scope:recipient
        }
        scope:actor = {
            is_adult = yes
            NOR = {
                has_trait_with_flag = carn_block_send_sex_interaction
                has_character_flag = carn_block_send_sex_interaction
                has_opinion_modifier = {
                    target = scope:recipient
                    modifier = carn_block_sex_interaction_to_opinion
                }
            }
        }
        scope:recipient = {
            is_adult = yes
            NOR = {
                has_trait_with_flag = carn_block_receive_sex_interaction
                has_character_flag = carn_block_receive_sex_interaction
                has_opinion_modifier = {
                    target = scope:actor
                    modifier = carn_block_sex_interaction_from_opinion
                }
            }
        }
        OR = {
            scope:actor = {
                carn_relationship_allows_free_sex_trigger = {
                    PARTNER = scope:recipient
                }
            }
            scope:recipient = {
                carn_is_working_as_prostitute_trigger = yes
            }
			scope:recipient = {
                cse_is_working_as_slave_prostitute_trigger = yes
            }
        }
    }

	cooldown = { months = carn_sex_interaction_cooldown }

    is_valid_showing_failures_only = {
        scope:actor = {
            carn_can_have_sex_trigger = yes
        }
        scope:recipient = {
            carn_can_have_sex_trigger = yes
        }
            
        # if this is a paid transaction, actor needs the gold
        trigger_if = {
            limit = {
                scope:recipient = {
                    carn_is_working_as_prostitute_trigger = yes
                }
                NOT = {
                    scope:actor = {
                        carn_relationship_allows_free_sex_trigger = {
                            PARTNER = scope:recipient
                        }
                    }
                }
            }
            scope:actor.gold >= scope:recipient.carn_prostitute_sex_interaction_price_value
        }
		trigger_else_if = {
            limit = {
                scope:recipient = {
                    cse_is_working_as_slave_prostitute_trigger = yes
                }
                NOT = {
                    scope:actor = {
                        carn_relationship_allows_free_sex_trigger = {
                            PARTNER = scope:recipient
                        }
                    }
                }
            }
            scope:actor.gold >= {
				value = scope:recipient.cse_slave_prostitute_worth_value
				multiply = 0.5
				round = yes
			}
        }
		trigger_else = {}
    }

    on_accept = {
        scope:actor = {

            if = {
				limit = { scope:recipient = { cse_is_working_as_courtesan_trigger = yes } }
				
				if = {
					limit = {
						NOT = { has_character_flag = carn_sex_interaction_effect_cd }
					}

					### STRESS ###
					if = {
						limit = {
							is_attracted_to_gender_of = scope:recipient
						}
						stress_impact = {
							base = 0
							chaste = medium_stress_impact_gain
							shy = medium_stress_impact_gain
							paranoid = medium_stress_impact_gain
							lustful = medium_stress_impact_loss
						}
					}
					else = {
						custom_tooltip = carn_sex_interaction_not_attracted_to_warning_tt
						stress_impact = {
							base = major_stress_impact_gain
						}
					}

					add_character_flag = {
						flag = carn_sex_interaction_effect_cd
						months = carn_sex_interaction_cooldown_base
					}
				}
				
				custom_tooltip = cse_courtesan_yearly_sex_event.0001.interaction
				scope:recipient = { save_scope_as = carn_sex_partner }
				save_scope_as = carn_sex_player
				trigger_event = { id = cse_courtesan_yearly_sex_event.0001 }
			}
			else = {
			
				# pay money for prostitution, and possibly lose piety if your faith dislikes this
				if = {
					limit = {
						scope:recipient = {
							carn_is_working_as_prostitute_trigger = yes
						}
						NOT = {
							carn_relationship_allows_free_sex_trigger = {
								PARTNER = scope:recipient
							}
						}
					}
					pay_short_term_gold = {
						target = scope:recipient
						gold = scope:recipient.carn_prostitute_sex_interaction_price_value
					}
					if = {
						limit = {
						   NOT = { cse_no_drama_trigger_prostitute = { PARTNER = scope:recipient } }
						}
						add_piety = minor_piety_loss
					}
				}
				if = {
					limit = {
						scope:recipient = {
							cse_is_working_as_slave_prostitute_trigger = yes
						}
						NOT = {
							carn_relationship_allows_free_sex_trigger = {
								PARTNER = scope:recipient
							}
						}
					}
					pay_short_term_gold = {
						target = scope:recipient
						gold = {
							value = scope:recipient.cse_slave_prostitute_worth_value
							multiply = 0.5
							round = yes
						}
					}
					if = {
						limit = {
						   NOT = { cse_no_drama_trigger_slave_prostitute = { PARTNER = scope:recipient } }
						}
						add_piety = minor_piety_loss
					}
				}

				if = {
					limit = {
						NOT = { has_character_flag = carn_sex_interaction_effect_cd }
					}
					
					# show possible effects from sex scene
					show_as_tooltip = {
						carn_had_sex_with_effect_v2 = {
							PARTNER = scope:recipient
						}
					}

					### STRESS ###
					if = {
						limit = {
							is_attracted_to_gender_of = scope:recipient
						}
						stress_impact = {
							base = minor_stress_impact_loss
							chaste = activity_stress_gain_impact
						}
					}
					else = {
						custom_tooltip = carn_sex_interaction_not_attracted_to_warning_tt
						stress_impact = {
							base = major_stress_impact_gain
						}
					}

					add_character_flag = {
						flag = carn_sex_interaction_effect_cd
						months = carn_sex_interaction_cooldown_base
					}
				}
				else = {
					custom_tooltip = carn_sex_interaction_effect_cd_tt
				}

				# request the sex scene
				hidden_effect = {

					# lovers and soulmates always consensual
					if = {
						limit = {
							scope:actor = {
								OR = {
									has_relation_lover = scope:recipient
									has_relation_soulmate = scope:recipient
								}
							}
						}
						carn_sex_scene_is_consensual_effect = yes
					}
					# for slaves and concubines, get scenes ranging from consensual to noncon
					else_if = {
						limit = {
							scope:actor = {
								OR = {
									is_concubine_of = scope:recipient
									has_relation_slave_owner = scope:recipient
								}
							}
						}
						# Consensual: I'm into you, and I either like you or you're super hot
						if = {
							limit = {
								scope:recipient = {
									OR = {
										opinion = {
											target = scope:actor
											value >= 50
										}
										scope:actor = { attraction >= 20 } # if you're hot enough they'll happily hatefuck you
									}
									is_attracted_to_gender_of = scope:actor
								}
							}
							carn_sex_scene_is_consensual_effect = yes
						}
						# dubcon: Either I'm into you but not that into you, or I don't swing that way but I like you enough to humor you
						else_if = {
							limit = {
								scope:recipient = {
									OR = {
										AND = {
											is_attracted_to_gender_of = scope:actor
											OR = {
												opinion = {
													target = scope:actor
													value > 0
												}
												scope:actor = { attraction >= 10 } # if you're hot enough they'll be kinda ok with it
											}
										}
										AND = {
											NOT = { is_attracted_to_gender_of = scope:actor }
											opinion = {
												target = scope:actor
												value >= 75
											}
										}
									}
								}
							}
							carn_sex_scene_is_dubcon_effect = yes
							carn_sex_scene_character_is_dom_player_effect = yes
						}
						# Noncon: I either hate you or I don't swing this way, get me outta here
						else = {
							carn_sex_scene_is_noncon_effect = yes
							carn_sex_scene_character_is_dom_player_effect = yes
						}
					}
					# get dubcon for characters that dislike you / are not attracted to you (but accept sex with you for some reason, like being a prostitute)
					else_if = {
						limit = {
							scope:recipient = {
								OR = {
									opinion = {
										target = scope:actor
										value < 0
									}
									NOT = { is_attracted_to_gender_of = scope:actor }
								}
							}
						}
						carn_sex_scene_is_dubcon_effect = yes					
						carn_sex_scene_character_is_dom_player_effect = yes
					}
					# fallback to consensual scene
					else = {
						carn_sex_scene_is_consensual_effect = yes
					}

					random_list = {
						60 = {
							carn_sex_scene_is_vaginal_effect = yes
							carn_sex_scene_is_cum_inside_effect = yes
						}
						20 = {
							carn_sex_scene_is_vaginal_effect = yes
							carn_sex_scene_is_cum_outside_effect = yes
						}
						10 = {
							trigger = { has_game_rule = carn_content_anal_enabled }
							carn_sex_scene_is_anal_effect = yes
						}
						10 = {
							carn_sex_scene_is_oral_effect = yes
						}
					}
					carn_sex_scene_character_is_giving_player_effect = yes
					
					# actually fire the sex scene
					carn_sex_scene_effect_v2 = {
							PARTNER = scope:recipient
					}
				}
			}
        }
    }

    auto_accept = yes
}